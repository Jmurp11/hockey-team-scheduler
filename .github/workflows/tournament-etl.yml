name: Tournament ETL Monthly Run

on:
  # Run on the 1st of every month at 2 AM UTC
  schedule:
    - cron: "0 2 1 * *"

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      location:
        description: "Location to override (optional)"
        required: false
        type: string

jobs:
  tournament-etl:
    runs-on: ubuntu-latest

    strategy:
      # Don't cancel other matrix jobs if one fails
      fail-fast: false
      # Limit concurrent jobs to avoid database conflicts
      max-parallel: 1
      matrix:
        include:
          # US Hockey Districts
          - location: “New Jersey, Delaware, and Pennsylvania”
            locationType: "states"
          - location: “Illinois, Iowa, Kansas, Missouri, Nebraska, and Wisconsin”
            locationType: "states"
          - location: “Indiana, Kentucky, Ohio, Tennessee, and West Virginia”
            locationType: "states"
          - location: “Massachusetts”
            locationType: "states"
          - location: “Michigan”
            locationType: "states"
          - location: “Minnesota”
            locationType: "states"
          - location: “Connecticut, Maine, New Hampshire, Rhode Island, and Vermont”
            locationType: "states"
          - location: “New York”
            locationType: "states"
          - location: “Alaska, California, Hawaii, Nevada, Oregon, and Washington”
            locationType: "states"
          - location: “Arizona, Colorado, Idaho, New Mexico, Oklahoma, Texas, and Utah”
            locationType: "states"
          - location: “Alabama, Arkansas, Florida, Georgia, Louisiana, Mississippi, North Carolina, South Carolina, and Virginia”
            locationType: "states"
          # Canadian Hockey Organizations
          - location: “British Columbia and Yukon”
            locationType: "provinces"
          - location: “Alberta”
            locationType: "provinces"
          - location: “Saskatchewan”
            locationType: "provinces"
          - location: “Manitoba”
            locationType: "provinces"
          - location: “Northwestern Ontario”
            locationType: "provinces"
          - location: “Ontario (Southern and Central Ontario)”
            locationType: "provinces"
          - location: “Eastern Ontario”
            locationType: "provinces"
          - location: “Quebec”
            locationType: "provinces"
          - location: “New Brunswick”
            locationType: "provinces"
          - location: “Nova Scotia”
            locationType: "provinces"
          - location: “Prince Edward Island”
            locationType: "provinces"
          - location: “Newfoundland and Labrador”
            locationType: "provinces"
          - location: “Northwest Territories and Nunavut”
            locationType: "territories"

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "tournament-etl/package-lock.json"

      - name: Install dependencies
        working-directory: ./tournament-etl
        run: npm ci

      - name: Run ETL for ${{ matrix.location }}
        working-directory: ./tournament-etl
        run: |
          npx tsx src/run-etl.ts \
            --location "${{ github.event.inputs.location || matrix.location }}" \
            --locationType "${{ github.event.inputs.locationType || matrix.locationType }}"
        env:
          # Pass environment variables to the ETL process
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Log completion
        run: |
          echo "✅ ETL completed for:"
          echo "  Location: ${{ github.event.inputs.location || matrix.location }}"
          echo "  Location Type: ${{ github.event.inputs.locationType || matrix.locationType }}"
  summary:
    runs-on: ubuntu-latest
    needs: tournament-etl
    if: always()

    steps:
      - name: ETL Summary
        run: |
          echo "🏒 Monthly Tournament ETL Run Complete"
          echo "Status: ${{ needs.tournament-etl.result }}"
          echo "Timestamp: $(date -u)"
