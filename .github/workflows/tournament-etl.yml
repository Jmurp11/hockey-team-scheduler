name: Tournament ETL Monthly Run

on:
  # Run on the 1st of every month at 2 AM UTC
  schedule:
    - cron: "0 2 1 * *"

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      location:
        description: "Location to override (optional)"
        required: false
        type: string

jobs:
  tournament-etl:
    runs-on: ubuntu-latest

    strategy:
      # Don't cancel other matrix jobs if one fails
      fail-fast: false
      # Limit concurrent jobs to avoid database conflicts
      max-parallel: 1
      matrix:
        include:
          # US Hockey Districts
          - location: â€œNew Jersey, Delaware, and Pennsylvaniaâ€
            locationType: "states"
          - location: â€œIllinois, Iowa, Kansas, Missouri, Nebraska, and Wisconsinâ€
            locationType: "states"
          - location: â€œIndiana, Kentucky, Ohio, Tennessee, and West Virginiaâ€
            locationType: "states"
          - location: â€œMassachusettsâ€
            locationType: "states"
          - location: â€œMichiganâ€
            locationType: "states"
          - location: â€œMinnesotaâ€
            locationType: "states"
          - location: â€œConnecticut, Maine, New Hampshire, Rhode Island, and Vermontâ€
            locationType: "states"
          - location: â€œNew Yorkâ€
            locationType: "states"
          - location: â€œAlaska, California, Hawaii, Nevada, Oregon, and Washingtonâ€
            locationType: "states"
          - location: â€œArizona, Colorado, Idaho, New Mexico, Oklahoma, Texas, and Utahâ€
            locationType: "states"
          - location: â€œAlabama, Arkansas, Florida, Georgia, Louisiana, Mississippi, North Carolina, South Carolina, and Virginiaâ€
            locationType: "states"
          # Canadian Hockey Organizations
          - location: â€œBritish Columbia and Yukonâ€
            locationType: "provinces"
          - location: â€œAlbertaâ€
            locationType: "provinces"
          - location: â€œSaskatchewanâ€
            locationType: "provinces"
          - location: â€œManitobaâ€
            locationType: "provinces"
          - location: â€œNorthwestern Ontarioâ€
            locationType: "provinces"
          - location: â€œOntario (Southern and Central Ontario)â€
            locationType: "provinces"
          - location: â€œEastern Ontarioâ€
            locationType: "provinces"
          - location: â€œQuebecâ€
            locationType: "provinces"
          - location: â€œNew Brunswickâ€
            locationType: "provinces"
          - location: â€œNova Scotiaâ€
            locationType: "provinces"
          - location: â€œPrince Edward Islandâ€
            locationType: "provinces"
          - location: â€œNewfoundland and Labradorâ€
            locationType: "provinces"
          - location: â€œNorthwest Territories and Nunavutâ€
            locationType: "territories"

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "tournament-etl/package-lock.json"

      - name: Install dependencies
        working-directory: ./tournament-etl
        run: npm ci

      - name: Run ETL for ${{ matrix.location }}
        working-directory: ./tournament-etl
        run: |
          npx tsx src/run-etl.ts \
            --location "${{ github.event.inputs.location || matrix.location }}" \
            --locationType "${{ github.event.inputs.locationType || matrix.locationType }}"
        env:
          # Pass environment variables to the ETL process
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Log completion
        run: |
          echo "âœ… ETL completed for:"
          echo "  Location: ${{ github.event.inputs.location || matrix.location }}"
          echo "  Location Type: ${{ github.event.inputs.locationType || matrix.locationType }}"
  summary:
    runs-on: ubuntu-latest
    needs: tournament-etl
    if: always()

    steps:
      - name: ETL Summary
        run: |
          echo "ğŸ’ Monthly Tournament ETL Run Complete"
          echo "Status: ${{ needs.tournament-etl.result }}"
          echo "Timestamp: $(date -u)"
